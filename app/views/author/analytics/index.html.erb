<% content_for :title, "Analytics · Author" %>

<div class="container mx-auto px-4 py-8">
  <!-- Header with Date Range Picker -->
  <div class="mb-8">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-4xl font-bold dark:text-white">Analytics</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Track your blog's performance and visitor behavior</p>
      </div>
      <%= link_to "← Back to Dashboard", author_dashboard_path, class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300" %>
    </div>

    <!-- Date Range Filter -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4">
      <%= form_with url: author_analytics_path, method: :get, class: "flex items-end gap-4" do |f| %>
        <div>
          <%= f.date_field :start_date, value: @start_date, class: "border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded px-3 py-2" %>
        </div>
        <div>
          <%= f.date_field :end_date, value: @end_date, class: "border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded px-3 py-2" %>
        </div>
        <%= f.submit "Apply", class: "bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded cursor-pointer" %>
        <%= link_to "Last 7 Days", author_analytics_path(start_date: 7.days.ago.to_date, end_date: Date.today), class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 py-2 px-4" %>
        <%= link_to "Last 30 Days", author_analytics_path(start_date: 30.days.ago.to_date, end_date: Date.today), class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 py-2 px-4" %>
        <%= link_to "Last 90 Days", author_analytics_path(start_date: 90.days.ago.to_date, end_date: Date.today), class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 py-2 px-4" %>
      <% end %>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Views</p>
      <p class="text-3xl font-bold dark:text-white mt-2"><%= number_with_delimiter(@analytics.total_views) %></p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Unique Visitors</p>
      <p class="text-3xl font-bold dark:text-white mt-2"><%= number_with_delimiter(@analytics.unique_visitors_count) %></p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Avg Views/Day</p>
      <p class="text-3xl font-bold dark:text-white mt-2"><%= @analytics.average_views_per_day %></p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Date Range</p>
      <p class="text-lg font-bold dark:text-white mt-2"><%= (@end_date.to_date - @start_date.to_date).to_i %> days</p>
    </div>
  </div>

  <!-- Main Chart -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6 mb-8">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Views Over Time</h3>
    <div style="position: relative; height: 300px;">
      <canvas
        data-controller="chart"
        data-chart-type-value="line"
        data-chart-data-value="<%= {
          labels: @analytics.views_over_time.keys,
          datasets: [{
            label: 'Page Views',
            data: @analytics.views_over_time.values,
            borderColor: 'rgb(79, 70, 229)',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            tension: 0.4,
            fill: true
          }]
        }.to_json %>"
        data-chart-options-value="<%= {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }.to_json %>"
      ></canvas>
    </div>
  </div>

  <!-- Top Documents & Sources -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Top Documents -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Top Documents</h3>
      <div class="space-y-3">
        <% @analytics.top_documents(10).each do |doc| %>
          <div class="flex items-center justify-between py-2 border-b dark:border-gray-700">
            <div class="flex-1 min-w-0">
              <%= link_to doc[:title], public_document_path(doc[:slug]),
                  class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 truncate block",
                  target: "_blank" %>
            </div>
            <span class="ml-4 text-gray-600 dark:text-gray-400 font-medium"><%= number_with_delimiter(doc[:views]) %> views</span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Top Sources -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Top Traffic Sources</h3>
      <div class="space-y-3">
        <% if @analytics.top_sources.any? %>
          <% @analytics.top_sources(10).each do |source, count| %>
            <div class="flex items-center justify-between py-2 border-b dark:border-gray-700">
              <span class="text-gray-800 dark:text-gray-200 truncate"><%= source || "Direct" %></span>
              <span class="text-gray-600 dark:text-gray-400 font-medium"><%= number_with_delimiter(count) %> visits</span>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500 dark:text-gray-400 text-sm">No referrer data available</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Referrers & Next Pages -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Top Referrers -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Top Referrers</h3>
      <div class="space-y-2 max-h-96 pr-2 overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 dark:[&::-webkit-scrollbar-track]:bg-gray-700 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-thumb]:bg-gray-600 [&::-webkit-scrollbar-thumb]:rounded-full hover:[&::-webkit-scrollbar-thumb]:bg-gray-400 dark:hover:[&::-webkit-scrollbar-thumb]:bg-gray-500">
        <% if @analytics.top_referrers.any? %>
          <% @analytics.top_referrers(15).each do |referrer, count| %>
            <div class="flex items-start justify-between py-2 border-b dark:border-gray-700 text-sm">
              <a href="<%= referrer %>" target="_blank" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 truncate flex-1 mr-2">
                <%= referrer.truncate(60) %>
              </a>
              <span class="text-gray-600 dark:text-gray-400 font-medium whitespace-nowrap"><%= count %></span>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500 dark:text-gray-400 text-sm">No referrer data available</p>
        <% end %>
      </div>
    </div>

    <!-- Top Next Pages -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Where Visitors Go Next</h3>
      <div class="space-y-2 max-h-96 overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 dark:[&::-webkit-scrollbar-track]:bg-gray-700 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-thumb]:bg-gray-600 [&::-webkit-scrollbar-thumb]:rounded-full hover:[&::-webkit-scrollbar-thumb]:bg-gray-400 dark:hover:[&::-webkit-scrollbar-thumb]:bg-gray-500">
        <% if @analytics.top_next_pages.any? %>
          <% @analytics.top_next_pages(15).each do |next_page, count| %>
            <div class="flex items-start justify-between py-2 border-b dark:border-gray-700 text-sm">
              <span class="text-gray-700 dark:text-gray-300 truncate flex-1 mr-2"><%= next_page.truncate(60) %></span>
              <span class="text-gray-600 dark:text-gray-400 font-medium whitespace-nowrap"><%= count %></span>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500 dark:text-gray-400 text-sm">No next page data available</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Device, Browser, OS Stats -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Device Breakdown -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Devices</h3>
      <div style="position: relative; height: 200px;">
        <canvas
          data-controller="chart"
          data-chart-type-value="doughnut"
          data-chart-data-value="<%= {
            labels: @analytics.device_breakdown.keys,
            datasets: [{
              data: @analytics.device_breakdown.values,
              backgroundColor: ['rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)']
            }]
          }.to_json %>"
          data-chart-options-value="<%= {
            responsive: true,
            maintainAspectRatio: false
          }.to_json %>"
        ></canvas>
      </div>
    </div>

    <!-- Browser Breakdown -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Browsers</h3>
      <div style="position: relative; height: 200px;">
        <canvas
          data-controller="chart"
          data-chart-type-value="doughnut"
          data-chart-data-value="<%= {
            labels: @analytics.browser_breakdown.keys,
            datasets: [{
              data: @analytics.browser_breakdown.values,
              backgroundColor: [
                'rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)',
                'rgb(139, 92, 246)', 'rgb(239, 68, 68)'
              ]
            }]
          }.to_json %>"
          data-chart-options-value="<%= {
            responsive: true,
            maintainAspectRatio: false
          }.to_json %>"
        ></canvas>
      </div>
    </div>

    <!-- OS Breakdown -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
      <h3 class="text-lg font-semibold dark:text-white mb-4">Operating Systems</h3>
      <div style="position: relative; height: 200px;">
        <canvas
          data-controller="chart"
          data-chart-type-value="doughnut"
          data-chart-data-value="<%= {
            labels: @analytics.os_breakdown.keys,
            datasets: [{
              data: @analytics.os_breakdown.values,
              backgroundColor: [
                'rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)',
                'rgb(139, 92, 246)', 'rgb(239, 68, 68)'
              ]
            }]
          }.to_json %>"
          data-chart-options-value="<%= {
            responsive: true,
            maintainAspectRatio: false
          }.to_json %>"
        ></canvas>
      </div>
    </div>
  </div>

  <!-- Top Visitors -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6 mb-8">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Top Visitors</h3>
    <div class="overflow-x-auto [&::-webkit-scrollbar]:h-2 [&::-webkit-scrollbar-track]:bg-gray-100 dark:[&::-webkit-scrollbar-track]:bg-gray-700 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-thumb]:bg-gray-600 [&::-webkit-scrollbar-thumb]:rounded-full hover:[&::-webkit-scrollbar-thumb]:bg-gray-400 dark:hover:[&::-webkit-scrollbar-thumb]:bg-gray-500">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-900">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Visitor ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">View Count</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Last Visit</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          <% @analytics.top_visitors(20).each do |visitor| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900 dark:text-gray-200">
                <%= visitor[:visitor_id].truncate(16) %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-200">
                <%= visitor[:view_count] %> views
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                <%= time_ago_in_words(visitor[:last_visit]) %> ago
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <%= link_to "View Activity",
                    author_analytics_visitor_path(visitor[:visitor_id], start_date: @start_date, end_date: @end_date),
                    class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Page Views -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-6">
    <h3 class="text-lg font-semibold dark:text-white mb-4">Recent Page Views</h3>
    <div class="overflow-x-auto [&::-webkit-scrollbar]:h-2 [&::-webkit-scrollbar-track]:bg-gray-100 dark:[&::-webkit-scrollbar-track]:bg-gray-700 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-thumb]:bg-gray-600 [&::-webkit-scrollbar-thumb]:rounded-full hover:[&::-webkit-scrollbar-thumb]:bg-gray-400 dark:hover:[&::-webkit-scrollbar-thumb]:bg-gray-500">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-900">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Document</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Visitor</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Location</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Device</th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          <% @analytics.recent_views(50).each do |view| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                <%= view.visited_at.strftime("%b %d, %H:%M") %>
              </td>
              <td class="px-6 py-4 text-sm">
                <%= link_to view.document.title, public_document_path(view.document),
                    class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300", target: "_blank" %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">
                <%= link_to view.unique_visitor_id.truncate(12),
                    author_analytics_visitor_path(view.unique_visitor_id, start_date: @start_date, end_date: @end_date),
                    class: "text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300" %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                <%= [view.city, view.country].reject(&:blank?).join(", ") || "Unknown" %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                <%= view.device.capitalize %> · <%= view.browser %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
