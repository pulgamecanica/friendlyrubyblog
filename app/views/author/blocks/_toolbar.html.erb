<!-- Sticky Toolbar Column -->
<div data-block-editor-target="toolbar"
     class="sticky top-20 h-fit flex flex-col gap-3"
     id="<%= dom_id(block) %>_toolbar">

  <!-- Block Info -->
  <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
    <div class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
      <%= block.type %>
    </div>
    <%= render "author/blocks/position", block: block %>
  </div>

  <!-- Normal Mode Tools -->
  <div data-block-editor-target="normalTools"
       class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 space-y-3 flex flex-col">

    <div class="flex gap-2">
      <button data-block-editor-target="collapseBtn"
              data-action="click->block-editor#toggleCollapse"
              class="flex-1 px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300 transition-colors">
        Collapse
      </button>

      <button class="drag-handle px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors cursor-move focus:outline-none focus:ring-0"
              title="Drag to reorder">
        <%= icon_drag_handle size: :xs, class: "text-gray-600 dark:text-gray-400" %>
      </button>
    </div>

    <!-- Code Block Controls (only for CodeBlock) -->
    <% if block.is_a?(CodeBlock) %>
      <div class="border-t dark:border-gray-600 pt-3">
        <div class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
          Code Controls
        </div>

        <!-- Interactive Toggle -->
        <% if block.can_be_interactive? %>
          <%= form_with url: toggle_interactive_author_document_block_path(block.document, block),
                        method: :patch,
                        data: {
                          turbo_frame: "#{dom_id(block)}_toolbar",
                          turbo: true
                        },
                        local: false,
                        class: "mb-2" do |f| %>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-700 dark:text-gray-300">Interactive Mode</span>
              <button type="submit"
                      class="<%= block.interactive? ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-600' %> relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <span class="<%= block.interactive? ? 'translate-x-6' : 'translate-x-1' %> inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
              </button>
            </div>
          <% end %>
        <% end %>

        <!-- Run Button (only when interactive and supports execution) -->
        <% if block.supports_execution? %>
          <button data-action="click->code-executor#run"
                  data-block-id="<%= block.id %>"
                  class="w-full px-2 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
            ‚ñ∂ Run Code
          </button>
        <% elsif block.interactive? %>
          <div class="text-xs text-gray-500 dark:text-gray-400 text-center py-1">
            Interactive mode enabled but execution not configured
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Image Carousel Controls (only for ImageBlock with multiple images) -->
    <% if block.is_a?(ImageBlock) && block.images.count > 1 %>
      <div class="border-t dark:border-gray-600 pt-3">
        <div class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
          Image Navigation
        </div>
        <div class="flex gap-2">
          <button data-action="click->image-carousel#previous"
                  class="flex-1 px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300 transition-colors">
            ‚Üê Previous
          </button>
          <button data-action="click->image-carousel#next"
                  class="flex-1 px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300 transition-colors">
            Next ‚Üí
          </button>
        </div>

        <!-- Image Indicators -->
        <div class="flex justify-center gap-1 mt-2">
          <% block.images.each_with_index do |_, index| %>
            <button data-action="click->image-carousel#goTo"
                    data-image-carousel-target="indicator"
                    data-index="<%= index %>"
                    class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600 hover:bg-gray-500 dark:hover:bg-gray-400 transition-colors focus:outline-none focus:ring-0">
            </button>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- MLX42 Controls (only for Mlx42Block) -->
    <% if block.is_a?(Mlx42Block) %>
      <div class="border-t dark:border-gray-600 pt-3" data-controller="mlx42-compiler">
        <div class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
          MLX42 Controls
        </div>

        <!-- Edit Code Button -->
        <button data-action="click->block-editor#enterEditMode"
                class="w-full px-2 py-1.5 text-xs border border-purple-300 text-purple-700 rounded hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-900/30 transition-colors mb-2">
          ‚úèÔ∏è Edit Code
        </button>

        <!-- Export WASM Files -->
        <button data-action="click->mlx42-preview#triggerExport"
                data-mlx42-preview-target="exportButton"
                class="w-full px-2 py-1.5 text-xs border border-blue-300 text-blue-700 rounded hover:bg-blue-50 dark:border-blue-700 dark:text-blue-300 dark:hover:bg-blue-900/30 transition-colors mb-2">
          üì¶ Export ZIP
        </button>

        <!-- Import WASM Files -->
        <label data-mlx42-preview-target="importButton"
                class="w-full px-2 py-1.5 text-xs border border-blue-300 text-blue-700 dark:border-blue-700 dark:text-blue-300 rounded hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors mb-2 cursor-pointer text-center block">
          üì• Import ZIP
          <input type="file"
                  accept=".zip"
                  data-action="change->mlx42-preview#triggerImport"
                  class="hidden" />
        </label>

        <!-- Export Status / Download Link -->
        <div data-mlx42-preview-target="exportStatus" class="mb-2"></div>

        <!-- Compile Button -->
        <button data-action="click->mlx42-compiler#compile"
                data-block-id="<%= block.id %>"
                data-document-id="<%= block.document.id %>"
                class="w-full px-2 py-1.5 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
          üî® Compile
        </button>

        <!-- Compilation Status -->
        <div id="mlx42_compilation_status_<%= block.id %>"
             data-turbo-stream-target
             class="mt-2 text-xs">
          <%= render "author/blocks/mlx42_compilation_status", block: block %>
        </div>
      </div>
    <% end %>

    <%= button_to "Delete",
        author_document_block_path(block.document, block),
        method: :delete,
        form: { data: { turbo_confirm: "Delete this block?" } },
        class: "w-full px-2 py-1.5 text-xs border border-red-300 dark:border-red-700 text-red-700 dark:text-red-400 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" %>
  </div>

  <!-- Edit Mode Tools -->
  <div data-block-editor-target="editTools"
       class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 pt-2 flex flex-col gap-2"
       style="display: none;">
    <% if block.is_a?(MarkdownBlock) %>
      <div class="text-xs text-center text-gray-400 dark:text-gray-500">Markdown Preview</div>

      <div class="flex flex-row gap-1 pb-2 border-b border-gray-300 dark:border-gray-600">
        <button data-block-editor-target="previewBtn"
                data-action="click->block-editor#togglePreview"
                class="w-full px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300 transition-colors">
          Hide
        </button>

        <button data-block-editor-target="layoutBtn"
                data-action="click->block-editor#toggleLayout"
                class="w-full px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300 transition-colors">
          Stack
        </button>
      </div>
    <% end %>
    <button data-action="click->block-editor#exitEditMode"
            class="w-full px-2 py-2 text-xs bg-gray-600 dark:bg-gray-700 text-white rounded hover:bg-gray-700 dark:hover:bg-gray-600 transition-colors">
      Close
    </button>
  </div>

  <!-- Update Button (Edit Mode Only) -->
  <div data-block-editor-target="updateButton"
       class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4"
       style="display: none;">

    <button data-block-editor-target="submitButton"
            data-action="click->block-editor#submitForm"
            class="w-full px-3 py-2 text-xs bg-green-600 text-white rounded hover:bg-green-700 font-medium transition-colors">
      Update Block
    </button>
  </div>
</div>