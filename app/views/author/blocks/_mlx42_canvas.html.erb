<% js_url  = block.compiled? ? rails_blob_url(block.js_file)   : "" %>
<% wasm_url = block.compiled? ? rails_blob_url(block.wasm_file) : "" %>
<% data_url = (block.data_file.attached? && block.compiled?) ? rails_blob_url(block.data_file) : "" %>

<div id="mlx42_preview_<%= block.id %>"
     data-controller="mlx42-runner"
     data-mlx42-runner-block-id-value="<%= block.id %>"
     data-mlx42-runner-export-url-value="<%= export_mlx42_files_author_document_block_path(block.document, block) %>"
     data-mlx42-runner-js-url-value="<%= js_url %>"
     data-mlx42-runner-wasm-url-value="<%= wasm_url %>"
     data-mlx42-runner-data-url-value="<%= data_url %>"
     class="relative">

  <% if block.compiled? %>
    <!-- Header with controls -->
    <div class="flex items-center justify-between px-4 py-2 bg-gray-900 rounded-t-lg border-b border-gray-700">
      <div class="flex items-center gap-2">
        <span class="text-xs font-semibold text-gray-300">MLXX42</span>
        <span class="text-xs font-semibold text-green-600 bg-green-100 px-2 py-0.5 rounded">INTERACTIVE</span>
      </div>

      <div class="flex items-center gap-2">
        <!-- Toggle Code View -->
        <button type="button"
                data-action="mlx42-preview#toggleCodeView"
                data-mlx42-preview-target="toggleCodeButton"
                class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors"
                title="Show/Hide Code">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
          </svg>
        </button>

        <!-- Toggle Console -->
        <button type="button"
                data-action="mlx42-runner#toggleConsole"
                class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors"
                title="Toggle Console">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </button>

        <!-- Toggle Controls -->
        <button type="button"
                data-action="mlx42-runner#toggleCapture"
                data-mlx42-runner-target="controlsButton"
                class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors"
                title="Toggle Controls">
          <svg class="h-4 w-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          Controls
        </button>
      </div>
    </div>

    <!-- Canvas Container -->
    <div class="relative bg-black" data-mlx42-runner-target="canvasContainer">
      <canvas id="mlx42_canvas_<%= block.id %>"
              data-mlx42-runner-target="canvas"
              tabindex="-1"
              width="800"
              height="600"
              class="w-full h-auto"></canvas>

      <!-- Click to Play Overlay -->
      <div data-mlx42-runner-target="playOverlay"
          data-action="click->mlx42-runner#play"
          class="absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center cursor-pointer hover:bg-opacity-70 transition-all group">
        <% if block.thumbnail.attached? %>
          <%= image_tag rails_blob_url(block.thumbnail),
                        class: "absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-40 transition-opacity" %>
        <% end %>
        <div class="relative z-10 text-center">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-purple-600 group-hover:bg-purple-500 group-hover:scale-110 transition-all shadow-2xl">
            <svg class="w-10 h-10 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>
          <p class="mt-4 text-white text-lg font-semibold">Click to Play</p>
          <p class="mt-1 text-gray-300 text-sm">MLX42 Interactive Program</p>
        </div>
      </div>

      <!-- Controls Active Indicator -->
      <div data-mlx42-runner-target="captureIndicator"
          style="display: none;"
          class="absolute top-2 left-2 bg-green-600 text-white text-xs px-3 py-1.5 rounded-lg shadow-lg z-20">
        <div class="flex items-center gap-2">
          <svg class="h-4 w-4 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <span>Controls Active (Click to release)</span>
        </div>
      </div>

      <!-- Loading State -->
      <div data-mlx42-runner-target="loader"
          style="display: none;"
          class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-30">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
          <p class="mt-4 text-white text-sm font-medium">Loading MLX42 Program...</p>
          <p data-mlx42-runner-target="loadProgress" class="text-xs text-gray-400 mt-1"></p>
        </div>
      </div>
    </div>

    <!-- Code Preview (code, assets) - Hidden by default -->
    <div data-mlx42-preview-target="contentView" style="display: none;" class="border-t border-gray-700 bg-gray-800 dark:bg-gray-800 p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2 text-sm font-medium text-gray-300">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
          </svg>
          <span>Source Code</span>
        </div>
        <span class="text-xs font-semibold text-gray-400 bg-gray-700 px-2 py-0.5 rounded">C</span>
      </div>
      <pre class="bg-gray-900 text-gray-100 p-4 rounded border border-gray-700 overflow-auto max-h-96 text-sm"><code class="language-c"><%= block.text || "// No source code available" %></code></pre>

      <% if block.assets.attached? %>
        <div class="mt-4">
          <div class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <span>Assets</span>
          </div>
          <div class="space-y-1">
            <% block.assets.each do |asset| %>
              <div class="text-sm font-mono text-purple-400 bg-gray-900 px-3 py-1.5 rounded border border-gray-700">assets/<%= asset.filename %></div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% unless block.compiled? %>
        <div class="mt-4 p-3 bg-yellow-900/30 border border-yellow-700 rounded">
          <p class="text-sm text-yellow-200">⚠️ Not compiled yet. Click "Compile" to build.</p>
        </div>
      <% end %>
    </div>

    <!-- Console Output (collapsible) -->
    <div data-mlx42-runner-target="consoleSection" class="border-t border-gray-700 bg-gray-800 dark:bg-gray-800 p-4 rounded-b-lg hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2 text-sm font-medium text-gray-300">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          <span>Console Output</span>
        </div>
        <button type="button"
                onclick="document.getElementById('mlx42_console_<%= block.id %>').value = ''"
                class="text-xs text-gray-400 hover:text-gray-200 font-medium">
          Clear
        </button>
      </div>
      <textarea id="mlx42_console_<%= block.id %>"
                data-mlx42-runner-target="console"
                rows="8"
                readonly
                class="w-full font-mono text-xs bg-gray-900 text-green-400 p-3 rounded border border-gray-700 focus:outline-none"></textarea>
    </div>
  <% else %>
    <div class="bg-gray-100 p-8 rounded text-center">
      <p class="text-gray-600">Compile your code to see the canvas</p>
    </div>
  <% end %>
</div>
